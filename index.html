<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Gift Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600;700&display=swap');
        body { font-family: 'Hind Siliguri', sans-serif; background: #0f172a; color: white; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-grad { background: linear-gradient(90deg, #6366f1 0%, #a855f7 100%); transition: 0.3s; }
        .btn-grad:hover { opacity: 0.9; transform: scale(0.98); }
        #appSection, #authSection { display: none; }
        
        /* স্ক্রোলিং এনিমেশন */
        .scrolling-container {
            overflow: hidden;
            white-space: nowrap;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
            padding: 10px 0;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .scrolling-text {
            display: inline-block;
            padding-left: 100%;
            animation: scroll-left 15s linear infinite;
        }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div id="authSection" class="w-full max-w-md mt-10 space-y-6">
        <div class="text-center">
            <div class="inline-block p-4 rounded-full bg-indigo-500/20 mb-4">
                <i class="fas fa-user-lock text-4xl text-indigo-400"></i>
            </div>
            <h1 class="text-3xl font-bold">লগইন করুন</h1>
        </div>
        <div class="glass p-8 rounded-3xl space-y-4">
            <input type="email" id="emailInput" class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-xl outline-none" placeholder="ইমেইল">
            <input type="password" id="passInput" class="w-full bg-slate-800/50 border border-slate-700 p-4 rounded-xl outline-none" placeholder="পাসওয়ার্ড">
            <button id="loginBtn" class="w-full btn-grad p-4 rounded-xl font-bold text-lg">লগইন করুন</button>
        </div>
    </div>

    <div id="appSection" class="w-full max-w-2xl flex flex-col space-y-4 mt-4">
        
        <div class="scrolling-container">
            <p id="marqueeText" class="scrolling-text text-indigo-300 font-semibold">লোড হচ্ছে...</p>
        </div>

        <div class="glass p-5 rounded-2xl flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <p class="text-xs text-slate-400">স্বাগতম,</p>
                    <p id="displayEmail" class="text-sm font-bold truncate max-w-[150px]">ইমেইল লোড হচ্ছে...</p>
                </div>
            </div>
            <button onclick="handleLogout()" class="bg-red-500/20 text-red-400 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-500 hover:text-white transition">লগআউট</button>
        </div>

        <div class="glass p-8 rounded-3xl text-center relative overflow-hidden">
            <img src="https://cdn-icons-png.flaticon.com/512/1169/1169905.png" class="w-24 mx-auto mb-6" alt="Gift">
            <h2 class="text-2xl font-bold mb-2">গিফট কোড ক্লেইম</h2>
            <div class="space-y-4">
                <input type="text" id="giftCodeInput" class="w-full bg-slate-900 border-2 border-slate-700 p-4 rounded-2xl text-center text-xl font-bold tracking-widest outline-none" placeholder="ENTER CODE">
                <button id="claimBtn" class="w-full btn-grad p-4 rounded-2xl font-bold text-lg">ক্লেইম করুন</button>
            </div>
        </div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, serverTimestamp, query, where, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBY2R6jBre2pjrW3cN0QP8LGrLldgKWEtc",
        authDomain: "smartpay-4cae4.firebaseapp.com",
        projectId: "smartpay-4cae4",
        storageBucket: "smartpay-4cae4.firebasestorage.app",
        messagingSenderId: "531344716314",
        appId: "1:531344716314:web:0eac7f60479bfd66f7d7a3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ডেটাবেস থেকে স্ক্রোলিং টেক্সট নিয়ে আসার ফাংশন
    async function loadScrollingText() {
        try {
            // আপনার ইমেজ অনুযায়ী WELCOME100 ডকুমেন্ট থেকে ডাটা নেয়া হচ্ছে
            const docRef = doc(db, "gift_codes", "WELCOME100"); 
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                document.getElementById('marqueeText').innerText = docSnap.data().scrollingText;
            }
        } catch (e) {
            console.error("Error fetching text:", e);
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'flex';
            document.getElementById('displayEmail').innerText = user.email;
            loadScrollingText(); // লগইন করার পর টেক্সট লোড হবে
        } else {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
        }
    });

    document.getElementById('loginBtn').onclick = async () => {
        const email = document.getElementById('emailInput').value.trim();
        const pass = document.getElementById('passInput').value.trim();
        if(!email || !pass) return alert("ইমেইল এবং পাসওয়ার্ড দিন");
        try { await signInWithEmailAndPassword(auth, email, pass); } 
        catch (err) { alert("ভুল ইমেইল বা পাসওয়ার্ড!"); }
    };

    document.getElementById('claimBtn').onclick = async () => {
        const codeInput = document.getElementById('giftCodeInput').value.trim();
        const user = auth.currentUser;
        if(!codeInput) return alert("কোড লিখুন");
        
        const btn = document.getElementById('claimBtn');
        btn.disabled = true; 
        btn.innerText = "যাচাই হচ্ছে...";

        try {
            const historyQ = query(collection(db, "history"), where("uid", "==", user.uid), where("code", "==", codeInput));
            const historySnap = await getDocs(historyQ);
            const userRedeemCount = historySnap.size;

            await runTransaction(db, async (transaction) => {
                const codeRef = doc(db, "gift_codes", codeInput);
                const codeSnap = await transaction.get(codeRef);

                if (!codeSnap.exists()) throw "ইনভ্যালিড কোড!";
                const data = codeSnap.data();
                
                // ক্লেইম লজিক (অপরিবর্তিত)
                const now = new Date();
                if (data.isActive !== true) throw "কোডটি ডি-অ্যাক্টিভ।";
                if (data.usedCount >= data.totalLimit) throw "সীমা শেষ।";
                if (userRedeemCount >= data.perUserLimit) throw `সীমা শেষ (${data.perUserLimit} বার)।`;

                const reward = data.perUserAmount || 0;
                transaction.update(doc(db, "users", user.uid), { giftWallet: increment(reward) });
                transaction.update(codeRef, { usedCount: increment(1) });
                transaction.set(doc(collection(db, "history")), {
                    uid: user.uid, code: codeInput, amount: reward, timestamp: serverTimestamp()
                });
                return reward;
            });
            alert(`সফলভাবে ক্লেইম হয়েছে!`);
        } catch (error) {
            alert(typeof error === 'string' ? error : "সার্ভার এরর!");
        } finally {
            btn.disabled = false; btn.innerText = "ক্লেইম করুন";
        }
    };

    window.handleLogout = () => signOut(auth);
</script>
</body>
</html>
